#!/usr/bin/env zsh
#
# Nest Build
#
# Wrap nest::build plans with shell hooks to stop build containers
# when interrupted.
#

if (( $# < 2 )); then
    print "Usage: $0 BUILD PROFILE [args...]" >&2
    print "  e.g. $0 stage1 haswell-workstation deploy=true" >&2
    exit 1
fi

build=$1; shift
profile=$1; shift
container="nest-${build}-${profile//\//-}"

cd "$(dirname $0)/.."

[[ $UID -eq 0 ]] && runcmd='env' || runcmd='sudo'

exec $runcmd BOLT_CLEANUP_CMD="podman stop ${container} >&/dev/null" \
    ./bin/bolt-wrapper plan run nest::build::${build} container="$container" profile="$profile" "$@" --stream