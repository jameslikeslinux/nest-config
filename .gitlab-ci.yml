---
stages:
  - test
  - deploy

validate:
  image: '${CI_REGISTRY}/nest/tools/pdk:${CI_HOST_CPU}'
  stage: 'test'
  script:
    - 'pdk validate --puppet-version=8.2.0'

unit:
  image: '${CI_REGISTRY}/nest/tools/pdk:${CI_HOST_CPU}'
  stage: 'test'
  script:
    - 'pdk test unit --puppet-version=8.2.0'

r10k:
  stage: 'deploy'
  tags: ['r10k']
  script:
    - 'r10k deploy environment "$CI_COMMIT_BRANCH" -pv'

.template: &template
  image: '${CI_REGISTRY}/nest/tools/buildah:${CI_HOST_CPU}'
  stage: 'deploy'
  script:
    - 'eval $(ssh-agent -s)'
    - 'chmod 600 "$SSH_PRIVATE_KEY"'
    - 'ssh-add "$SSH_PRIVATE_KEY"'
    - 'mkdir -p debug/usr/lib/debug'
    - 'buildah login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" "$CI_REGISTRY"'
    - 'buildah bud --cap-add SYS_PTRACE --security-opt seccomp=unconfined
                   --build-arg BOLT_TAG="$CPU"
                   --build-arg SSH_AUTH_SOCK="$SSH_AUTH_SOCK"
                   -v "${SSH_AUTH_SOCK}:${SSH_AUTH_SOCK}:ro"
                   -t "${CI_REGISTRY_IMAGE}:${CPU}" .'
    - 'buildah push "${CI_REGISTRY_IMAGE}:${CPU}"'

package:
  <<: *template
  tags: ['arm64']
  variables:
    CPU: 'cortex-a53'
