---
resources:
  - apiVersion: v1
    kind: Secret
    metadata:
      name: "%{nest::kubernetes::helm_release}-secrets"
      namespace: "%{nest::kubernetes::helm_namespace}"
    data:
      database-url: "%{nest::kubernetes::vaultwarden_db_url}"
  - apiVersion: v1
    kind: Secret
    metadata:
      name: "%{nest::kubernetes::helm_release}-registry-auths"
      namespace: "%{nest::kubernetes::helm_namespace}"
    data:
      .dockerconfigjson: "%{nest::kubernetes::registry_auths}"
    type: kubernetes.io/dockerconfigjson
  - apiVersion: batch/v1
    kind: CronJob
    metadata:
      name: "%{nest::kubernetes::helm_release}-backup"
      namespace: "%{nest::kubernetes::helm_namespace}"
    spec:
      schedule: '0 */3 * * *'
      timeZone: 'America/New_York'
      jobTemplate:
        spec:
          ttlSecondsAfterFinished: 21600 # 6h; keep last two backup jobs in history
          template:
            spec:
              containers:
                - name: nest
                  image: registry.gitlab.james.tl/nest/puppet:cortex-a53
                  imagePullPolicy: Always
                  command:
                    - 'zsh'
                    - '-c'
                    - 'eval $(ssh-agent -s) &&
                      ssh-add &&
                      bolt plan run nest::eyrie::backup_vaultwarden name=%{nest::kubernetes::helm_release}'
                  env:
                    - name: KUBECONFIG
                      value: '/nest/home/kubeconfigs/eyrie.conf'
                  volumeMounts:
                    - name: bolt-config
                      mountPath: '/etc/puppetlabs/bolt'
                      readOnly: true
                    - name: eyaml-config
                      mountPath: '/etc/eyaml'
                      readOnly: true
                    - name: james-ssh-key
                      mountPath: '/home/james/.ssh/id_ed25519'
                      readOnly: true
                    - name: nest
                      mountPath: '/nest'
              imagePullSecrets:
                - name: "%{nest::kubernetes::helm_release}-registry-auths"
              restartPolicy: Never
              securityContext:
                runAsUser: 1000
                runAsGroup: 1000
              volumes:
                - name: bolt-config
                  hostPath:
                    path: '/etc/puppetlabs/bolt'
                    type: Directory
                - name: eyaml-config
                  hostPath:
                    path: '/etc/eyaml'
                    type: Directory
                - name: james-ssh-key
                  hostPath:
                    path: '/home/james/.ssh/id_ed25519'
                    type: File
                - name: nest
                  hostPath:
                    path: '/nest'
                    type: Directory

values:
  adminToken:
    value: "%{nest::kubernetes::vaultwarden_admin_token_hash}"
  data:
    name: vaultwarden-data
    size: 10Gi
  database:
    type: mysql
    existingSecret: "%{nest::kubernetes::helm_release}-secrets"
    existingSecretKey: database-url
  smtp:
    host: smtp.gmail.com
    username:
      value: system@james.tl
    password:
      value: "%{lookup('nest::service::bitwarden::smtp_password')}"
  service:
    type: LoadBalancer

patches:
  - patch: |
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: "%{nest::kubernetes::helm_release}-vaultwarden"
        namespace: "%{nest::kubernetes::helm_namespace}"
      spec:
        template:
          spec:
            containers:
              - name: nest
                image: registry.gitlab.james.tl/nest/stage1:cortex-a53-server
                imagePullPolicy: Always
                command: ['/usr/bin/sshd', '-D', '-e']
                securityContext:
                  capabilities:
                    add:
                      - SYS_CHROOT  # for sshd
                      - SYS_PTRACE
                volumeMounts:
                  - name: nest
                    mountPath: '/nest'
                  - name: ssh-host-key
                    mountPath: '/etc/ssh/ssh_host_ed25519_key'
                    readOnly: true
                  - name: vaultwarden-data
                    mountPath: '/srv/vaultwarden/data'
                ports:
                  - name: ssh
                    containerPort: 22
            shareProcessNamespace: true
            volumes:
              - name: nest
                hostPath:
                  path: '/nest'
                  type: Directory
              - name: ssh-host-key
                hostPath:
                  path: '/etc/ssh/ssh_host_ed25519_key'
                  type: File
  - patch: |
      apiVersion: v1
      kind: Service
      metadata:
        name: "%{nest::kubernetes::helm_release}-vaultwarden"
        namespace: "%{nest::kubernetes::helm_namespace}"
        labels:
          'james.tl/nest': 'stage1'
      spec:
        ports:
          - name: ssh
            port: 22
