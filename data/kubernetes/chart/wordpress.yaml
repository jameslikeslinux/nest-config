---
values:
  podSecurityContext:
    fsGroup: 1000
  containerSecurityContext:
    runAsUser: 1000
  livenessProbe:
    initialDelaySeconds: 600
  wordpressPassword: 'wordpress' # throwaway
  allowEmptyPassword: false
  mariadb:
    auth:
      database: "%{nest::bolt::helm_release}"
      username: "%{nest::bolt::helm_release}"
      password: "%{nest::bolt::wordpress_db_password}"
      rootPassword: "%{lookup('nest::service::mysql::root_password')}"
  extraVolumes:
  - name: nest
    hostPath:
      path: '/nest'
      type: Directory
  - name: ssh-host-key
    hostPath:
      path: '/etc/ssh/ssh_host_ed25519_key'
      type: File
  sidecars:
  - name: nest
    image: registry.gitlab.james.tl/nest/stage1:cortex-a53-server
    imagePullPolicy: Always
    command: ['/usr/bin/sshd', '-D', '-e']
    securityContext:
      capabilities:
        add:
        - SYS_CHROOT  # for sshd
        - SYS_PTRACE
    volumeMounts:
    - mountPath: '/nest'
      name: nest
    - mountPath: '/etc/ssh/ssh_host_ed25519_key'
      name: ssh-host-key
      readOnly: true
    - mountPath: '/srv/wordpress'
      name: wordpress-data
      subPath: wordpress
    ports:
    - name: ssh
      containerPort: 22
  service:
    extraPorts:
    - name: ssh
      port: 22

patches:
  - patch: |
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: "%{nest::bolt::helm_release}-wordpress"
        namespace: "%{nest::bolt::helm_namespace}"
      spec:
        template:
          spec:
            shareProcessNamespace: true
  - patch: |
      apiVersion: v1
      kind: Service
      metadata:
        name: "%{nest::bolt::helm_release}-wordpress"
        namespace: "%{nest::bolt::helm_namespace}"
        labels:
          'james.tl/nest': 'stage1'
