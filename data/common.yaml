---
lookup_options:
  nest::kernel_cmdline:
    merge: 'unique'
  nest::kernel_config:
    merge: 'hash'
  nest::package_env:
    merge: 'hash'
  nest::package_keywords:
    merge: 'hash'
  nest::service::wordpress::sites:
    merge: 'hash'

classes:
  - 'nest'

nest::cnames:
  nzbget.nest: 'falcon.nest'
  ombi.nest: 'falcon.nest'
  plex.nest: 'falcon.nest'
  puppet.nest: 'falcon.nest'
  puppetdb.nest: 'falcon.nest'
  radarr.nest: 'falcon.nest'
  smtp.nest: 'falcon.nest'
  sonarr.nest: 'falcon.nest'
  registry.gitlab.james.tl: 'falcon.nest'
nest::cups_servers:
  - 'falcon.nest'
  - 'hawk.nest'
nest::distcc_hosts:
  falcon.nest: 16
nest::hosts:
  unifi.home:
    ip: '172.22.1.12'
nest::nestfs_hostname: 'falcon.nest'
nest::openvpn_hostname: 'nest.james.tl'

nest::package_keywords:
  # I always want the latest of these
  app-emulation/qemu: {}
  app-misc/tmux: {}
  app-editors/vim: {}
  app-editors/vim-core: {}
  media-libs/mesa: {}
  sys-fs/zfs: {}
  sys-fs/zfs-kmod: {}

  # Podman and dependencies
  app-emulation/crun: {}
  app-emulation/podman: {}
  app-emulation/conmon: {}
  app-emulation/slirp4netns: {}
  sys-fs/fuse-overlayfs: {}

  # For qemu
  sys-firmware/edk2-ovmf:
    version: '~202105'
  sys-firmware/ipxe:
    version: '~1.21.1'
  sys-firmware/seabios:
    version: '~1.14.0'
  sys-firmware/sgabios:
    version: '~0.1_pre10'

nest::kernel_config:
  # Support distcc
  CONFIG_GCC_PLUGINS: n

  # Preferences
  CONFIG_LOGO: n

  # Networking
  CONFIG_NETFILTER: y
  CONFIG_NETFILTER_ADVANCED: y
  CONFIG_NF_CONNTRACK: m
  CONFIG_NETFILTER_XTABLES: m
  CONFIG_NETFILTER_XT_MATCH_COMMENT: m
  CONFIG_NETFILTER_XT_MATCH_CONNTRACK: m
  CONFIG_NETFILTER_XT_MATCH_MULTIPORT: m
  CONFIG_NETFILTER_XT_MATCH_PKTTYPE: m
  CONFIG_NETFILTER_XT_MATCH_STATE: m
  CONFIG_IP_NF_IPTABLES: m
  CONFIG_IP_NF_FILTER: m
  CONFIG_IP_NF_TARGET_REJECT: m
  CONFIG_IP_NF_NAT: m
  CONFIG_IP_NF_TARGET_MASQUERADE: m
  CONFIG_IP_NF_MANGLE: m
  CONFIG_IP6_NF_IPTABLES: m
  CONFIG_IP6_NF_FILTER: m
  CONFIG_IP6_NF_TARGET_REJECT: m
  CONFIG_IP6_NF_NAT: m
  CONFIG_IP6_NF_TARGET_MASQUERADE: m
  CONFIG_IP6_NF_MANGLE: m
  CONFIG_BRIDGE: m
  CONFIG_VLAN_8021Q: m
  CONFIG_BONDING: m
  CONFIG_TUN: m

  # Device drivers
  CONFIG_BLK_DEV_NVME: m
  CONFIG_HW_RANDOM_VIRTIO: m
  CONFIG_USB_SERIAL: m
  CONFIG_USB_SERIAL_CH341: m      # for Pinebook Pro adapter
  CONFIG_USB_SERIAL_CP210X: m     # for Raspberry Pi adapter
  CONFIG_USB_SERIAL_FTDI_SIO: m   # for BeagleBone Black adapter
  CONFIG_VIRTIO_PCI: y
  CONFIG_VIRTIO_BALLOON: m

  # Filesystems
  CONFIG_FUSE_FS: m
  CONFIG_FSCACHE: y
  CONFIG_CACHEFILES: m
  CONFIG_SQUASHFS: m
  CONFIG_SQUASHFS_XZ: y
  CONFIG_NFS_V4_1: y
  CONFIG_NFS_V4_2: y
  CONFIG_NFS_FSCACHE: y
  CONFIG_NFSD: m
  CONFIG_NFSD_V4: y

  # For zswap
  CONFIG_FRONTSWAP: y
  CONFIG_ZSWAP: y
  CONFIG_Z3FOLD: y

  # For systemd
  CONFIG_CHECKPOINT_RESTORE: y
  CONFIG_FANOTIFY: y
  CONFIG_GENTOO_LINUX_INIT_SYSTEMD: y

  # For containers
  CONFIG_POSIX_MQUEUE: y
  CONFIG_MEMCG: y
  CONFIG_MEMCG_SWAP: y
  CONFIG_CGROUP_PIDS: y
  CONFIG_USER_NS: y
  CONFIG_NETFILTER_XT_MARK: m
  CONFIG_NETFILTER_XT_MATCH_ADDRTYPE: m
  CONFIG_BRIDGE_VLAN_FILTERING: y
  CONFIG_VETH: m

  # For Kubernetes
  CONFIG_CGROUP_SCHED: y
  CONFIG_CFS_BANDWIDTH: y
  CONFIG_BRIDGE_NETFILTER: m
  CONFIG_NETFILTER_NETLINK_QUEUE: m
  CONFIG_NF_CT_NETLINK: m
  CONFIG_NF_CT_NETLINK_HELPER: m
  CONFIG_NETFILTER_NETLINK_GLUE_CT: y
  CONFIG_VXLAN: m

  # For libvirt
  CONFIG_VIRTUALIZATION: y
  CONFIG_VHOST_NET: m
  CONFIG_NETFILTER_XT_CONNMARK: m
  CONFIG_NETFILTER_XT_TARGET_CHECKSUM: m
  CONFIG_BRIDGE_NF_EBTABLES: m
  CONFIG_BRIDGE_EBT_T_NAT: m
  CONFIG_BRIDGE_EBT_MARK_T: m
  CONFIG_NET_SCHED: y
  CONFIG_NET_SCH_HTB: m
  CONFIG_NET_SCH_SFQ: m
  CONFIG_NET_SCH_INGRESS: m
  CONFIG_NET_CLS_FW: m
  CONFIG_NET_CLS_U32: m
  CONFIG_NET_CLS_ACT: y
  CONFIG_NET_ACT_POLICE: m
  CONFIG_MACVLAN: m
  CONFIG_MACVTAP: m

  # For iwd
  CONFIG_KEY_DH_OPERATIONS: y
  CONFIG_CRYPTO_MD4: m
  CONFIG_CRYPTO_SHA1: y
  CONFIG_CRYPTO_SHA512: y
  CONFIG_CRYPTO_DES: m
  CONFIG_CRYPTO_USER_API_SKCIPHER: m
  CONFIG_PKCS8_PRIVATE_KEY_PARSER: m


#
# Other module defaults
#

apache::mpm_module: 'worker'
apache::mod::ssl::ssl_protocol: ['all', '-SSLv2', '-SSLv3', '-TLSv1', '-TLSv1.1']

puppet::puppetmaster: 'puppet.nest'
puppet::environment: 'main'
