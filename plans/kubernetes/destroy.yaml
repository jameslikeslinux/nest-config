---
description: 'Tear down a Kubernetes cluster'

parameters:
  name:
    type: String
    description: 'Name of the cluster'

  control_plane:
    type: TargetSpec
    description: 'Control plane to reset'

  workers:
    type: TargetSpec
    default: []
    description: 'Workers to reset'

steps:
  - description: 'Remove worker nodes'
    plan: nest::kubernetes::remove_worker
    parameters:
      drain: false
    targets: $workers

  - description: 'Reset control plane'
    command: 'kubeadm reset --force'
    run_as: root
    targets: $control_plane

  - description: 'Remove Kubeconfig'
    command: "rm -f '/nest/home/kubeconfigs/${name}.conf'"
    targets: localhost
