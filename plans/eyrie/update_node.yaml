---
description: Update Eyrie nodes

parameters:
  targets:
    description: List of Eyrie nodes to update
    type: TargetSpec

  kubelet_version:
    description: Hold back to this version pending cluster upgrade
    type: String
    default: '1.30'

steps:
  - description: Drain the nodes
    plan: nest::kubernetes::drain_node
    targets: $targets

  - description: Update CLI config
    plan: nest::puppet::run
    targets: $targets
    parameters:
      tags: ['cli']

  # Make room for update on 32G nodes
  - description: Remove old debug data
    command: rm -rf /usr/lib/debug/*
    targets: $targets
    catch_errors: true

  - description: Update the nodes
    plan: nest::host::update
    targets: $targets
    parameters:
      reboot: true

  - description: Downgrade kubelet
    command: emerge --oneshot --verbose "<=sys-cluster/kubelet-${kubelet_version}.9999" && systemctl restart kubelet
    env_vars:
      kubelet_version: $kubelet_version
    targets: $targets
    run_as: root

  - description: Uncordon the nodes
    plan: nest::kubernetes::uncordon_node
    targets: $targets